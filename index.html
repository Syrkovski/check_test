<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Генератор БСО</title>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <style>
    :root {
      color-scheme: light;
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
    }

    body {
      margin: 0;
      padding: 24px;
      background: #fff;
      color: #000;
    }

    header {
      margin-bottom: 24px;
    }

    h1, h2 {
      margin: 0 0 12px;
      font-weight: 600;
    }

    p {
      margin: 0 0 16px;
    }

    form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      max-width: 420px;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
    }

    input, select, textarea, button {
      font: inherit;
      padding: 10px;
      border: 1px solid #000;
      background: #fff;
      color: #000;
    }

    button {
      cursor: pointer;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .section {
      margin-bottom: 32px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 960px;
    }

    th, td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #f5f5f5;
      font-weight: 600;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .notice {
      padding: 10px;
      border: 1px solid #000;
      margin-bottom: 16px;
      background: #f8f8f8;
    }
  </style>
</head>
<body>
  <header>
    <h1>Генератор БСО</h1>
    <p>Минимальный прототип для ИП без кассы: фиксированный шаблон PDF, авто-нумерация и реестр.</p>
  </header>

  <section class="section" aria-labelledby="create-title">
    <h2 id="create-title">Создать БСО</h2>
    <div class="notice" id="current-number">Номер будет сгенерирован автоматически по формуле YYYYMMDD-XXX.</div>
    <form id="bso-form">
      <label>
        Клиент
        <input type="text" id="client" name="client" placeholder="ФИО или Физлицо" required />
      </label>
      <label>
        Услуга
        <input type="text" id="service" name="service" required />
      </label>
      <label>
        Сумма, ₽
        <input type="number" id="amount" name="amount" min="0" step="0.01" required />
      </label>
      <label>
        Время оплаты
        <input type="time" id="time" name="time" required />
      </label>
      <label>
        Способ оплаты
        <select id="payment" name="payment" required>
          <option value="Наличные">Наличные</option>
          <option value="Безнал">Безнал</option>
          <option value="СБП">СБП</option>
        </select>
      </label>
      <label>
        Комментарий (необязательно)
        <textarea id="comment" name="comment"></textarea>
      </label>
      <button type="submit">Создать PDF</button>
    </form>
  </section>

  <section class="section" aria-labelledby="registry-title">
    <h2 id="registry-title">Реестр БСО</h2>
    <table id="registry">
      <thead>
        <tr>
          <th>Номер</th>
          <th>Дата</th>
          <th>Время</th>
          <th>Клиент</th>
          <th>Услуга</th>
          <th>Сумма</th>
          <th>Оплата</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-jp/AV7pTHXKFFitvolG/GpNZgbf+168Q5e0siJmq9hw3rroWAtxEvsC0BpvyEukgqS0bkkCm1cWkI7xJ9N8DPg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    const STORAGE_KEY = 'bso-records';
    const IP_DETAILS = {
      name: 'ИП Иванов Иван Иванович',
      inn: 'ИНН 123456789012',
      ogrnip: 'ОГРНИП 123456789012345',
      address: 'г. Москва, ул. Пример, д. 1',
      bank: 'Тинькофф Банк',
      account: 'Р/с 40802810900000000001',
      bik: 'БИК 044525974'
    };

    const form = document.getElementById('bso-form');
    const registryBody = document.querySelector('#registry tbody');
    const currentNumberEl = document.getElementById('current-number');
    const timeInput = document.getElementById('time');

    function loadRecords() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch (e) {
        return [];
      }
    }

    function saveRecords(records) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function formatDate(date) {
      return date.toISOString().slice(0, 10);
    }

    function todayNumberPrefix(date) {
      const d = date || new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}${m}${day}`;
    }

    function nextNumber(records, date) {
      const prefix = todayNumberPrefix(date);
      const sameDay = records.filter(r => r.date === formatDate(date));
      const seq = sameDay.length + 1;
      return `${prefix}-${String(seq).padStart(3, '0')}`;
    }

    function renderCurrentNumber() {
      const records = loadRecords();
      const number = nextNumber(records, new Date());
      currentNumberEl.textContent = `Следующий номер: ${number}`;
    }

    function renderRegistry() {
      const records = loadRecords().sort((a, b) => b.createdAt - a.createdAt);
      registryBody.innerHTML = '';
      records.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${record.number}</td>
          <td>${record.date}</td>
          <td>${record.time}</td>
          <td>${record.client}</td>
          <td>${record.service}</td>
          <td>${record.amount}</td>
          <td>${record.payment}</td>
          <td class="actions"><button data-number="${record.number}" class="download">Скачать PDF</button></td>
        `;
        registryBody.appendChild(row);
      });
    }

    function render() {
      renderCurrentNumber();
      renderRegistry();
    }

    function buildPdf(record) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const lineHeight = 8;
      let y = 15;
      doc.setFontSize(14);
      doc.text('Бланк строгой отчетности', 14, y);
      y += lineHeight;
      doc.setFontSize(12);
      doc.text(`Номер: ${record.number}`, 14, y);
      y += lineHeight;
      doc.text(`Дата: ${record.date}`, 14, y);
      y += lineHeight;
      doc.text(`Время: ${record.time}`, 14, y);
      y += lineHeight;
      doc.text(`Клиент: ${record.client || 'Физлицо'}`, 14, y);
      y += lineHeight;
      doc.text(`Услуга: ${record.service}`, 14, y);
      y += lineHeight;
      doc.text(`Сумма: ${record.amount} ₽`, 14, y);
      y += lineHeight;
      doc.text(`Способ оплаты: ${record.payment}`, 14, y);
      y += lineHeight;
      if (record.comment) {
        const lines = doc.splitTextToSize(`Комментарий: ${record.comment}`, 180);
        doc.text(lines, 14, y);
        y += lines.length * 7;
      }

      y += lineHeight;
      doc.text('Реквизиты исполнителя', 14, y);
      y += lineHeight;
      doc.text(IP_DETAILS.name, 14, y);
      y += lineHeight;
      doc.text(IP_DETAILS.inn, 14, y);
      y += lineHeight;
      doc.text(IP_DETAILS.ogrnip, 14, y);
      y += lineHeight;
      doc.text(IP_DETAILS.address, 14, y);
      y += lineHeight;
      doc.text(IP_DETAILS.bank, 14, y);
      y += lineHeight;
      doc.text(IP_DETAILS.account, 14, y);
      y += lineHeight;
      doc.text(IP_DETAILS.bik, 14, y);

      return doc;
    }

    function downloadPdf(record) {
      const doc = buildPdf(record);
      doc.save(`${record.number}.pdf`);
    }

    function handleDownload(event) {
      if (event.target.classList.contains('download')) {
        const number = event.target.getAttribute('data-number');
        const records = loadRecords();
        const record = records.find(r => r.number === number);
        if (record) {
          downloadPdf(record);
        }
      }
    }

    function getTimeValue() {
      const value = timeInput.value;
      if (/^\d{2}:\d{2}$/.test(value)) {
        return value;
      }
      const now = new Date();
      return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const records = loadRecords();
      const now = new Date();
      const date = formatDate(now);
      const time = getTimeValue();
      const record = {
        number: nextNumber(records, now),
        date,
        time,
        client: document.getElementById('client').value.trim() || 'Физлицо',
        service: document.getElementById('service').value.trim(),
        amount: Number(document.getElementById('amount').value).toFixed(2),
        payment: document.getElementById('payment').value,
        comment: document.getElementById('comment').value.trim(),
        createdAt: Date.now()
      };

      records.push(record);
      saveRecords(records);
      render();
      downloadPdf(record);
      form.reset();
      timeInput.value = '';
    });

    registryBody.addEventListener('click', handleDownload);

    (function init() {
      const now = new Date();
      timeInput.placeholder = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      render();
    })();
  </script>
</body>
</html>
