        <p class="section-description">Дата и время подставятся автоматически, но их можно скорректировать вручную внизу формы.</p>
      <div class="notice" id="current-number">Номер генерируется автоматически по формуле YYYYMMDD-XXX; дата и время оплаты по умолчанию берутся текущие, но можно ввести свои значения ниже.</div>
            <input
              type="text"
              id="service"
              name="service"
              value="Оплата уроков по информатике онлайн"
              readonly
              required
            />
        <label>
          Основание платежа
          <input
            type="text"
            id="basis"
            name="basis"
            value="Репетиторские услуги дополнительного обучения по информатике"
            required
          />
        </label>
        <div class="field-row">
          <label>
            Дата платежа
            <input type="date" id="payment-date" name="payment-date" required />
          </label>
          <label>
            Время платежа
            <input type="time" id="payment-time" name="payment-time" required />
          </label>
        </div>
    const paymentDateInput = document.getElementById('payment-date');
    const paymentTimeInput = document.getElementById('payment-time');
    const basisInput = document.getElementById('basis');
        amount: calculateAmount(quantity, unitPrice),
        basis: raw.basis || raw.service || ''
    function formatInputDate(date) {
      const d = date || new Date();
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function formatInputTime(date) {
      const d = date || new Date();
      return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    }

    function setPaymentDateTimeDefaults(date = new Date()) {
      if (paymentDateInput && paymentTimeInput) {
        const defaultDate = formatInputDate(date);
        const defaultTime = formatInputTime(date);
        paymentDateInput.value = defaultDate;
        paymentTimeInput.value = defaultTime;
        paymentDateInput.defaultValue = defaultDate;
        paymentTimeInput.defaultValue = defaultTime;
      }
    }

    function getSelectedDateTime() {
      if (!paymentDateInput || !paymentTimeInput) {
        return new Date();
      }

      const dateValue = paymentDateInput.value;
      const timeValue = paymentTimeInput.value;

      if (dateValue && timeValue) {
        const [year, month, day] = dateValue.split('-').map(Number);
        const [hours, minutes] = timeValue.split(':').map(Number);
        if ([year, month, day, hours, minutes].every(Number.isFinite)) {
          return new Date(year, (month || 1) - 1, day || 1, hours || 0, minutes || 0);
        }
      }

      return new Date();
    }

    function renderCurrentNumber() {
      const records = loadRecords();
      const selectedDate = getSelectedDateTime();
      const prefix = todayNumberPrefix(selectedDate);
      const overrides = loadSequenceOverrides();
      const overrideSeq = overrides[prefix];
      const number = nextNumber(records, selectedDate);
      const isManual = Number.isFinite(overrideSeq) && overrideSeq > 0;
      currentNumberEl.innerHTML = `
        <span class="number-display">
          <span>Следующий номер:</span>
          <span class="number-value">${number}</span>
          ${isManual ? '<span class="pill">ручной</span>' : ''}
        </span>
      `;

      if (numberPrefixInput) {
        numberPrefixInput.value = `${prefix}-`;
      }
      if (numberSequenceInput) {
        const suggested = Number.isFinite(overrideSeq) && overrideSeq > 0
          ? overrideSeq
          : maxSequenceForPrefix(records, prefix) + 1;
        numberSequenceInput.value = suggested;
    }
      doc.text(`Документ № ${record.number} от ${record.date} за ${record.time}`, left, y, { align: 'left' });
      y += 12;


        pushLines(record.basis || record.service);
      const prefix = todayNumberPrefix(getSelectedDateTime());
    if (paymentDateInput) {
      paymentDateInput.addEventListener('change', () => renderCurrentNumber());
    }

    if (paymentTimeInput) {
      paymentTimeInput.addEventListener('change', () => renderCurrentNumber());
    }

      const selectedDate = getSelectedDateTime();
      const date = formatDate(selectedDate);
      const time = formatTime(selectedDate);
        number: nextNumber(records, selectedDate),
        basis: basisInput ? basisInput.value.trim() : document.getElementById('service').value.trim(),
      const prefix = todayNumberPrefix(selectedDate);
      setPaymentDateTimeDefaults(new Date());
      renderCurrentNumber();
      setPaymentDateTimeDefaults(new Date());
        <p class="section-description">
          Дата и время подставятся автоматически, но их можно скорректировать вручную внизу формы.
        </p>
        <div class="section-description" aria-live="polite">
          <p>Дата и время подставятся автоматически, но их можно скорректировать вручную внизу формы.</p>
          <p>Номер строится по формуле YYYYMMDD-XXX и подсказка ниже всегда показывает актуальный вариант.</p>
        </div>
      const prefix = todayNumberPrefix(getSelectedDateTime());
